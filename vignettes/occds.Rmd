---
title: "Creating a OCCDS ADaM"
author: "admiral team"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: false
vignette: >
  %\VignetteIndexEntry{Creating ADAE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This article describes creating a OCCDS ADaM. Examples are currently 
presented and tested in the context of ADAE  However, the examples could be
applied to other OCCDS ADaMs such as ADCM (?), ADMH, and ADDV, where ... (?).

<b>Note:  </b> </font><i> All examples assume CDISC SDTM and/or ADaM format as input unless 
otherwise specified. </i>

<b> <span style="color: red"> None of the code chunks are executing/displaying
results.  Is that something we want to do? </span> </b>

## Programming Workflow

* [Read in data](#readdata)
* [Derive/Impute end and start analysis date/time and relative day](#datetime)
* [Derive durations](#duration)
* [Derive analysis phase and period](#phase_period)
* [Derive planned and actual treatment](#trtpa)
* [Derive severity, causality, and toxicity grade](#severity)
* [Derive treatement flags](#trtfag)
* [Derive occurrence flags](#occflag)
* [Derive query variables](#query)

<b> <span style="color: red"> Do we want to include company specific derivations 
such as treatment flags, dosage related variables, datacut, etc? </span> </b>

### Read in data {#readdata}

To start, all dataframes needed for the creation of `ADAE` should be read into
the environment. This will be a company specific process. Some of the 
dataframes needed may be:

  * `AE`, `SUPPAE`
  * `SUPPDM`
  * `ADSL`
  
<b> <span style="color: red"> How to treat `SUPPAE` and `SUPPDM`? </span> </b>

<b> <span style="color: red"> Split deriving predecessors into another section? </span> </b>
  
The `initialize()` function can help create the starting point of the `ADAE` 
dataset by adding all predecessor variables.

Example call:

```{r eval=FALSE}
meta <- read_dap_m3("DAP_M3.xlsx")
adae <- initialize("ADAE", meta, list(adsl, ae))
```

### Derive/Impute end and start analysis date/time and relative day {#datetime}

This part includes variables `AENDTM`, `AENDT`, `AENDY`, `ASTDTM`, `ASTDT`, and 
`ASTDY`. 
The function `derive_vars_dtm()` can be used to derive `AENDTM` and 
`ASTDTM` where `ASTDTM` could be company-specific. 
`AENDT` and `ASTADT` can be created with a simple `mutate`, and 
`derive_var_aendy` and `derive_var_astdy` can be used to create 
`AENDY` and `ASTDY` respectively.

Example calls:

```{r eval=FALSE}
adae <- adae %>% 
  derive_vars_dtm(
    dtc = AEENDTC,
    new_vars_prefix = "AEN",
    date_imputation = "last",
    time_imputation = "last",
    max_dates = list(DTHDT, DCUTDT)
  ) %>% # AENDTM derived
  muatate(AENDT = date(AENDTM)) %>% # AENDT derived
  derive_var_aendy(
    reference_date = TRTSDT, 
    date = AENDT
  ) # AENDY derived
```

### Derive durations {#duration}

The function `derive_duration()` can be used to create the variables 
`ADURN` and `ADURU`. 

Example call:

```{r eval=FALSE}
adae <- adae %>%
  derive_duration(
    new_var = ADURN,
    new_var_unit = ADURU,
    start_date = AESTDTC,
    end_date = AEENDTC,
    in_unit = "days",
    out_unit = "days",
    add_one = TRUE,
    trunc_out = FALSE
  )
```

### Derive analysis phase and period {#phase_period}



### Derive planned and actual treatment {#trtpa}



### Derive severity, causality, and toxicity grade {#severity}

The variables `ASEV`, `AREL`, and `ATOXGR` can be added by simply `mutate` as 
they essentially come from the `AE` dataset.

Example call:

```{r eval=FALSE}
adae <- adae %>%
  mutate(ASEV = AESEV, 
         AREL = AEREL, 
         ATOXGR = AETOXGR)
```

### Derive treatement flags {#trtflag}



### Derive occurrence flags {#occflag}

The function `derive_extreme_flag()` can help derive variables such as `AOCCIFL`, 
`AOCCPIFL`, `AOCCSIFL`, `AOCXIFL`, `AOCXPIFL`, and `AOCXSIFL`.

Example call:

```{r eval=FALSE}
adae <- adae %>% 
  derive_extreme_flag(
  new_var = AOCCIFL,
  by_vars = exprs(USUBJID),
  order = exprs(ATOXGR, ASTDTM, AESEQ),
  flag_filter = exprs(ANL01FL == ‘Y’)
  )
```

### Derive query variables {#query}

The function `derive_query_vars()` can help derive the `SMQ` and `CQ` variables 
given a standard query dataset. More details can be found in the documentation 
of this function.

<b> <span style="color: red"> Provide more detail about the query dataset here or link to somewhere? </span> </b>

Example call:

```{r eval=FALSE}
adae <- adae %>%
  derive_query_vars(queries)
```




