---
title: "Creating an OCCDS ADaM"
output: 
  rmarkdown::html_vignette:
    toc: false
vignette: >
  %\VignetteIndexEntry{Creating an OCCDS ADaM}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This article describes creating an OCCDS ADaM. Examples are currently 
presented and tested in the context of ADAE.
However, the examples could be applied to other OCCDS ADaMs such as 
ADCM, ADMH, ADDV, etc.

**Note:** 
*All examples assume CDISC SDTM and/or ADaM format as input unless otherwise specified.*

## Programming Workflow

* [Read in Data](#readdata)
* [Derive/Impute End and Start Analysis Date/time and Relative Day](#datetime)
* [Derive Durations](#duration)
* [Derive Analysis Phase and Period](#phase_period)
* [Derive Planned and Actual Treatment](#trtpa)
* [Derive Date/Date-time of Last Dose](#last_dose)
* [Derive Severity, Causality, and Toxicity Grade](#severity)
* [Derive Treatement Emergent Flag](#trtfag)
* [Derive Occurrence Flags](#occflag)
* [Derive Query Variables](#query)

### Read in Data {#readdata}

Let's start by attaching packages and loading some example datasets:

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(lubridate)
library(admiral)

data(ae)
data(adsl)
```


To start, all data frames needed for the creation of `ADAE` should be read into
the environment. This will be a company specific process. Some of the data
frames needed may be:

  * `AE`, `SUPPAE`
  * `SUPPDM`
  * `ADSL`
  
To derive Supplemental Qualifiers, `derive_vars_suppqual()` can be used. 

```{r}
ae <- derive_vars_suppqual(ae, suppae)
head(suppae)
head(select(ae, USUBJID, AEDECOD, AETRTEM))
```

Now start creating ADAE by joining the required data sets together. 

```{r}
adae <- left_join(ae, adsl, by = c("STUDYID", "USUBJID")) 
```



### Derive/Impute End and Start Analysis Date/time and Relative Day {#datetime}

This part includes variables `ASTDTM`, `ASTDT`, `ASTDY`, `AENDTM`, `AENDT`, and `AENDY`. 
The function `derive_vars_dtm()` can be used to derive `ASTDTM` and `AENDTM` 
where `ASTDTM` could be company-specific. 
`ASTADT` and `AENDT` can be created with a simple `dplyr::mutate()`. 
`derive_var_astdy()` and `derive_var_aendy()` can be used to create `ASTDY` and `AENDY`, respectively.

```{r}
adae <- adae %>% 
  derive_vars_dtm(
    dtc = AESTDTC,
    new_vars_prefix = "AST",
    date_imputation = "first",
    time_imputation = "first",
    min_dates = list(TRTSDT)
  ) %>% 
  derive_vars_dtm(
    dtc = AEENDTC,
    new_vars_prefix = "AEN",
    date_imputation = "last",
    time_imputation = "last",
    max_dates = list(DTHDT, EOSDT)
  ) %>% 
  mutate(
    ASTDT = date(ASTDTM),
    AENDT = date(AENDTM) 
  ) %>% 
  derive_var_astdy(
    reference_date = TRTSDT, 
    date = ASTDT
  ) %>%
  derive_var_aendy(
    reference_date = TRTSDT, 
    date = AENDT
  )
```

See also [Date and Time Imputation](imputation.html).

### Derive Durations {#duration}

The function `derive_vars_duration()` can be used to create the variables 
`ADURN` and `ADURU`. 

```{r}
adae <- adae %>%
  derive_vars_duration(
    new_var = ADURN,
    new_var_unit = ADURU,
    start_date = ASTDT,
    end_date = AENDT,
    in_unit = "days",
    out_unit = "days",
    add_one = TRUE,
    trunc_out = FALSE
  )
```

### Derive Analysis Phase and Period {#phase_period}

*These functionalities are in progress.*


### Derive Planned and Actual Treatment {#trtpa}

*These functionalities are in progress.*


### Derive Date/Date-time of Last Dose {#last_dose}

The function `derive_last_dose()` can be used to derive the last dose date. 
Additionally, this function can also provide the traceability variables 
(e.g. `LDOSEDOM`, `LDOSESEQ`) using the `traceability_vars` argument.


```{r}
data(ex_single)
adae <- adae %>% 
  derive_last_dose(
    ex_single,
    filter_ex = (EXDOSE > 0 | (EXDOSE == 0 & grepl("PLACEBO", EXTRT))) &
      nchar(EXENDTC) >= 10,
    dose_start = EXSTDTC,
    dose_end = EXENDTC,
    analysis_date = ASTDT,
    dataset_seq_var = AESEQ,
    new_var = LDOSEDTM,
    output_datetime = TRUE,
    check_dates_only = FALSE
  )
```


### Derive Severity, Causality, and Toxicity Grade {#severity}

The variables `ASEV`, `AREL`, and `ATOXGR` can be added by simply
`dplyr::mutate()` if no imputation is required.

```{r}
adae <- adae %>%
  mutate(
    ASEV = AESEV, 
    AREL = AEREL
  )
```

### Derive Treatment Emergent Flag {#trtflag}

To derive the treatment emergent flag `TRTEMFL`, one can use simple
`dplyr::mutate()`. In the example below, we use 30 days in the flag derivation.

```{r}
adae <- adae %>% 
  mutate(
    TRTEMFL = ifelse(ASTDT >= TRTSDT & ASTDT <= TRTEDT + days(30), "Y", "")
  )
```



### Derive Occurrence Flags {#occflag}

The function `derive_extreme_flag()` can help derive variables such as `AOCCIFL`, 
`AOCCPIFL`, `AOCCSIFL`, `AOCXIFL`, `AOCXPIFL`, and `AOCXSIFL`.

If grades were collected, the following can be used.

```{r, eval=FALSE}
adae <- adae %>% 
  derive_extreme_flag(
    new_var = AOCCIFL,
    by_vars = vars(USUBJID),
    order = vars(ASTDTM, ATOXGR, AESEQ),
    flag_filter = TRTEMFL == "Y", 
    mode = "last"
  )
```

Similarly, `ASEV` can also be used to derive the occurrence flags if severity is
collected. In this case, the variable may need to be firstly recorded into a
numeric one:

```{r, eval=FALSE}
adae %>% 
  mutate(
    ASEVN = as.integer(factor(ASEV, levels = c("MILD", "MODERATE", "SEVERE", "DEATH THREATENING")))
  ) %>% 
  derive_extreme_flag(
    new_var = AOCCIFL,
    by_vars = vars(USUBJID),
    order = vars(ASTDTM, ASEVN, AESEQ),
    flag_filter = TRTEMFL == "Y", 
    mode = "last"
  )
```


### Derive Query Variables {#query}

*These functionalities are in progress.*
