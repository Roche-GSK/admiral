---
title: "Visit and Period Variables"
output:
  rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Visit and Period Variables}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The derivation of visit variables like `AVISIT`, `AVISITN`, `AWLO`,
`AWHI`, ... or period, subperiod, or phase variables like `APERIOD`,
`TRT01A`, `TRT02A`, `ASPER`, `PHSDTM`, `PHEDTM`, ... is highly
study-specific. Therefore admiral cannot provide functions which derive
these variables. However, for common scenarios like visit assignments
based on time windows or deriving BDS period variables from ADSL period
variables, functions are provided which support those derivations.

## Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(tibble)
library(dplyr, warn.conflicts = FALSE)
library(lubridate)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(admiraldev)
```

# Visit variables (`AVISIT`, `AVISITN`, `AWLO`, `AWHI`, ...) {#visits}

The most common ways of deriving `AVISIT` and `AVISITN` are:

-   The variables are set to the collected visits (`VISIT` and
`VISITNUM`).
-   The variables are set based on time windows.

The former can be achieved simply by calling `mutate()`, like in the
vignettes and the template scripts.

For the latter a (study-specific) reference dataset needs to be created
which provides for each visit the start and end day (`AWLO` and `AWHI`)
and the values of other visit related variables (`AVISIT`, `AVISITN`,
`AWTARGET`, ...).

```{r}
windows <- tribble(
  ~AVISIT,    ~AWLO, ~AWHI, ~AVISITN, ~AWTARGET,
  "BASELINE",   -30,     1,        0,         1,
  "WEEK 1",       2,     7,        1,         5,
  "WEEK 2",       8,    15,        2,        11,
  "WEEK 3",      16,    22,        3,        19,
  "WEEK 4",      23,    30,        4,        26
)
```

Then the visits can be assigned based on the analysis day (`ADY`) by
calling `derive_vars_joined()`:

```{r}
adbds <- tribble(
  ~USUBJID, ~ADY,
  "1",       -33,
  "1",        -2,
  "1",         3,
  "1",        24,
  "2",        NA,
)

derive_vars_joined(
  adbds,
  dataset_add = windows,
  filter_join = AWLO <= ADY & ADY <= AWHI,
  join_type = "all",
)
```

# Period, Subperiod, and Phase Variables

If periods, subperiods, or phases are used, the corresponding variables
have to be consistent across all datasets. This can be achieved by
defining the periods, subperiods, or phases once and then using this
definition for all datasets. The definition can be stored in ADSL or in
a separate dataset. In the following examples, this separate dataset is
called period/phase reference dataset depending what data it contains.

## A Note on Study Specific Code

The sections below showcase the available tools in admiral to work with period, 
subperiod and phase variables. However, at some point study specific code will 
always be required. There are two options:

-   Study specific code is used to first derive the variables `PxxSwSDT` and
`PxxSwEDT` in ADSL. Then `create_period_dataset()` and
`derive_vars_joined()` can be used to derive period/subperiod
variables like `ASPER` or `ASPRSDT` in BDS and OCCDS datasets. (See
[example](#adsl_example).)

-   Study specific code is used to derive a dataset with one
observation per patient, period, and subperiod (see [period
reference dataset](#reference)). Then `derive_vars_period()` can be
used to derive `PxxSwSDT` and `PxxSwEDT` in ADSL and
`derive_vars_joined()` can be used to derive period/subperiod
variables like `ASPER` or `ASPRSDT` in BDS and OCCDS datasets.

It depends on the specific definition of the periods/subperiods which
option works best. If the definition is based on other ADSL variables,
the first option would work best. If the definition is based on
vertically structured data like exposure data (EX dataset), the second
option should be used. This vignette contains examples for both workflows.


## The Period/Phase Reference Dataset {#reference}

The period/phase reference dataset should be created according to the design and ADaM needs of the study in question. It should contain one observation per subject and
period, subperiod, or phase. See the [next section](#example_period) for an 
example dataset.

The admiral functions expect separate datasets for periods, subperiods,
and phases. For periods the numeric variable `APERIOD` is expected, for
subperiods the numeric variables `APERIOD` and `ASPER`, and for phases
the numeric variable `APHASEN`.

## Example Creation of the Period/Phase Reference Dataset {#example_period}

Consider a simple crossover study with the following design:

<img src="https://raw.githubusercontent.com/pharmaverse/admiral/2321_period_examples/inst/visit_periods/dummy_study_design.png" width="630" height="252"/>

Given this design, the ADaM programmer may wish to split the study into two periods:

* Period 1 (Day 1 to Week 16);
* Period 2 (Week 16 to End of Study).

Alternatively (or additionally) one could split into two phases:

* Phase 1 - Treatment (Day 1 to Week 28);
* Phase 2 - Follow-up (Week 28 to End of Study).

Consider the following exposure dataset:

```{r echo=FALSE}
ex <- tribble(
  ~STUDYID, ~USUBJID,  ~VISIT,    ~EXTRT,   ~EXSTDTC,
  "xyz",    "1",       "Day 1",   "Drug X", "2022-01-02",
  "xyz",    "1",       "Week 4",  "Drug X", "2022-02-05",
  "xyz",    "1",       "Week 8",  "Drug X", "2022-03-01",
  "xyz",    "1",       "Week 12", "Drug X", "2022-04-03",
  "xyz",    "1",       "Week 16", "Drug Y", "2022-05-03",
  "xyz",    "1",       "Week 20", "Drug Y", "2022-06-02",
  "xyz",    "1",       "Week 24", "Drug Y", "2022-07-01",
  "xyz",    "1",       "Week 28", "Drug Y", "2022-08-04",
  "xyz",    "2",       "Day 1",   "Drug Y", "2023-10-20",
  "xyz",    "2",       "Week 4",  "Drug Y", "2023-11-21",
  "xyz",    "2",       "Week 8",  "Drug Y", "2023-12-19",
  "xyz",    "2",       "Week 12", "Drug Y", "2024-01-19",
  "xyz",    "2",       "Week 16", "Drug X", "2024-02-20",
  "xyz",    "2",       "Week 20", "Drug X", "2024-03-17",
  "xyz",    "2",       "Week 24", "Drug X", "2024-04-22",
  "xyz",    "2",       "Week 28", "Drug X", "2024-05-21"
)

ex
```

Then to create a period reference dataset, code like this (or similar) would suffice:

```{r echo=TRUE}
period_ref <- ex %>%
  # Select visits marking the start of each period
  filter(VISIT %in% c("Day 1", "Week 16")) %>%
  # Create APERIOD, APERSDT, TRTA based on SDTM counterparts
  mutate(
    APERIOD = case_when(
      VISIT == "Day 1" ~ 1,
      VISIT == "Week 16" ~ 2
    ),
    APERSDT = ymd(EXSTDTC),
    TRTA = EXTRT
  ) %>%
  # Create APEREDT based on start date of next period
  arrange(USUBJID, desc(APERSDT)) %>%
  group_by(USUBJID) %>%
  mutate(
    APEREDT = lag(APERSDT) - 1 # one day before start of next period
  ) %>%
  # Tidy up
  ungroup() %>%
  arrange(USUBJID, APERSDT) %>%
  select(-starts_with("EX"), -VISIT)

period_ref
```

The workflow above populates the Period End Date `APEREDT` for all periods 
except the last one. The value of the last period could then be populated 
with the End of Study Date (`EOSDT`) from ADSL, to obtain:

```{r echo=TRUE}
adsl <- tribble(
  ~STUDYID,  ~USUBJID,  ~EOSDT,
  "xyz",     "1",       ymd("2022-09-10"),
  "xyz",     "2",       ymd("2024-06-30")
)

period_ref <- period_ref %>%
  left_join(adsl, by = c("STUDYID", "USUBJID")) %>%
  mutate(APEREDT = case_when(
    APERIOD == "1" ~ APEREDT,
    APERIOD == "2" ~ EOSDT
  )) %>%
  select(-EOSDT)

period_ref
```

A very similar process could be followed for the phase reference dataset 
for the study phases, this time using Day 1 and Week 28 as reference 
visits, to obtain:

```{r echo=FALSE}
phase_ref <- ex %>%
  # Select visits marking the start of each phase
  filter(VISIT %in% c("Day 1", "Week 28")) %>%
  # Create APHASE(N), PHSDT based on SDTM counterparts
  mutate(
    APHASEN = case_when(
      VISIT == "Day 1" ~ 1,
      VISIT == "Week 28" ~ 2
    ),
    APHASE = case_when(
      APHASEN == 1 ~ "TREATMENT",
      APHASEN == 2 ~ "FUP"
    ),
    PHSDT = ymd(EXSTDTC)
  ) %>%
  # Create PHEDT based on start date of next phase
  arrange(USUBJID, desc(PHSDT)) %>%
  group_by(USUBJID) %>%
  mutate(
    PHEDT = lag(PHSDT) - 1 # one day before start of next phase
  ) %>%
  # Tidy up
  ungroup() %>%
  arrange(USUBJID, APHASEN) %>%
  select(-starts_with("EX"), -VISIT) %>%
  # Add PHEDT for second Phase
  left_join(adsl, by = c("STUDYID", "USUBJID")) %>%
  mutate(PHEDT = case_when(
    APHASEN == 1 ~ PHEDT,
    APHASEN == 2 ~ EOSDT
  )) %>%
  select(-EOSDT)

phase_ref
```

## Creating ADSL Period, Subperiod, or Phase Variables {#periods_adsl}

If a period/phase reference dataset is available, the ADSL variables for
periods, subperiods, or phases can be created from this dataset by
calling `derive_vars_period()`.

For example the phase reference dataset from the previous section can
be used to add the phase variables (`PHwSDT`, `PHwEDT`, and `APHASEw`)
to ADSL:

```{r}
adsl <- derive_vars_period(
  adsl,
  dataset_ref = phase_ref,
  new_vars = exprs(PHwSDT = PHSDT, PHwEDT = PHEDT, APHASEw = APHASE)
) %>%
  select(STUDYID, USUBJID, PH1SDT, PH1EDT, PH2SDT, PH2EDT, APHASE1, APHASE2)

adsl
```

## Creating BDS and OCCDS Period, Subperiod, or Phase Variables {#periods_bds}

If a period/phase reference dataset is available, BDS and OCCDS variables for
periods, subperiods, or phases can be created by calling
`derive_vars_joined()`.

For example the variables `APHASEN`, `PHSDT`, `PHEDT`, `APHASE` can be
derived from the phase reference dataset defined above.

```{r}
adae <- tribble(
  ~STUDYID, ~USUBJID, ~ASTDT,
  "xyz",    "1",      "2022-01-31",
  "xyz",    "1",      "2022-05-02",
  "xyz",    "1",      "2022-08-24",
  "xyz",    "1",      "2022-09-09",
  "xyz",    "2",      "2023-12-25",
  "xyz",    "2",      "2024-06-07",
) %>%
  mutate(ASTDT = ymd(ASTDT))

derive_vars_joined(
  adae,
  dataset_add = phase_ref,
  by_vars = exprs(STUDYID, USUBJID),
  filter_join = PHSDT <= ASTDT & ASTDT <= PHEDT,
  join_type = "all"
)
```

If no period/phase reference dataset is available but period/phase variables are in
ADSL, the period/phase reference dataset can be created from ADSL by calling
`create_period_dataset()`.

For [example]{#adsl_example}, a phase reference dataset can be created from the 
ADSL dataset created above:

```{r}
create_period_dataset(
  adsl,
  new_vars = exprs(PHSDT = PHwSDT, PHEDT = PHwEDT, APHASE = APHASEw)
)
```

# Treatment Variables (`TRTxxP`, `TRTxxA`, `TRTP`, `TRTA`, ...)

In studies with multiple periods the treatment can differ by period,
e.g. for a crossover trial - see the [previous section](#example_period)
for an example design showcasing this. CDISC defines variables for planned and
actual treatments in ADSL (`TRTxxP`, `TRTxxA`, `TRxxPGy`, `TRxxAGy`,
...) and corresponding variables in BDS and OCCDS datasets (`TRTP`,
`TRTA`, `TRTPGy`, `TRTAGy`, ...). They can be derived in the same way
(and same step) as the period, subperiod, and phase variables.

## Creating ADSL Treatment Variables {#treatment_adsl}

If the treatment information is included in the period/phase reference
dataset, the treatment ADSL variables can be created by calling
`derive_vars_period()`. This is showcased below using the period reference
dataset from previous sections.

```{r}
adsl <- derive_vars_period(
  adsl,
  dataset_ref = period_ref,
  new_vars = exprs(
    APxxSDT = APERSDT,
    APxxEDT = APEREDT,
    TRTxxA = TRTA
  )
) %>%
  select(
    STUDYID, USUBJID,
    TRT01A, TRT02A,
    AP01SDT, AP01EDT, AP02SDT, AP02EDT
  )

adsl
```

## Creating BDS and OCCDS Treatment Variables {#treatment_bds}

If a period/phase reference dataset is available, BDS and OCCDS variables for
treatment can be created by calling `derive_vars_joined()`.

For example the variables `APERIOD` and `TRTA` can be derived from the
period reference dataset defined above.

```{r}
adae <- tribble(
  ~STUDYID, ~USUBJID, ~ASTDT,
  "xyz",    "1",      "2022-01-31",
  "xyz",    "1",      "2022-05-02",
  "xyz",    "1",      "2022-08-24",
  "xyz",    "1",      "2022-09-09",
  "xyz",    "2",      "2023-12-25",
  "xyz",    "2",      "2024-06-07",
)

derive_vars_joined(
  adae,
  dataset_add = period_ref,
  by_vars = exprs(STUDYID, USUBJID),
  new_vars = exprs(APERIOD, TRTA),
  join_vars = exprs(APERSDT, APEREDT),
  join_type = "all",
  filter_join = APERSDT <= ASTDT & ASTDT <= APEREDT
)
```

If no period/phase reference dataset is available but period/phase variables are in
ADSL, then the former can be created from ADSL by calling `create_period_dataset()`.

For example, a period reference dataset for periods and treatments can
be created from the ADSL dataset created above:

```{r}
create_period_dataset(
  adsl,
  new_vars = exprs(APERSDT = APxxSDT, APEREDT = APxxEDT, TRTA = TRTxxA)
)
```
